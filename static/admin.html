<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n - Lista de Asistentes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'up-gold': {
                            50: '#fefdf4',
                            100: '#fef9e7',
                            200: '#fef2c7',
                            300: '#fde68a',
                            400: '#fcd34d',
                            500: '#f59e0b',
                            600: '#d97706',
                            700: '#b45309',
                            800: '#92400e',
                            900: '#78350f',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-up-gold-50 to-up-gold-100 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-lg border-b-4 border-up-gold-500">
        <div class="container mx-auto px-4 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-up-gold-800">Panel de Administraci√≥n</h1>
                    <p class="text-up-gold-600 mt-1">Lista de Asistentes Confirmados</p>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="bg-up-gold-600 text-white px-4 py-2 rounded-lg hover:bg-up-gold-700 transition duration-300">
                        üè† Inicio
                    </a>
                    <button onclick="refreshData()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
                        üîÑ Actualizar
                    </button>
                    <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-300">
                        üíæ Exportar CSV
                    </button>
                    <button onclick="confirmDeleteAll()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                        üóëÔ∏è Eliminar Todos
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Estad√≠sticas -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center">
                    <div class="text-3xl text-green-500 mr-4">‚úÖ</div>
                    <div>
                        <p class="text-sm text-gray-600">Confirmados (S√ç)</p>
                        <p class="text-2xl font-bold text-gray-800" id="confirmed-count">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <div class="flex items-center">
                    <div class="text-3xl text-red-500 mr-4">‚ùå</div>
                    <div>
                        <p class="text-sm text-gray-600">No Asisten</p>
                        <p class="text-2xl font-bold text-gray-800" id="declined-count">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-up-gold-500">
                <div class="flex items-center">
                    <div class="text-3xl text-up-gold-500 mr-4">üë•</div>
                    <div>
                        <p class="text-sm text-gray-600">Total Personas</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-people">0</p>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center">
                    <div class="text-3xl text-blue-500 mr-4">üìã</div>
                    <div>
                        <p class="text-sm text-gray-600">Total Registros</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-registrations">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtros -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Filtros</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por nombre:</label>
                    <input type="text" id="search-name" placeholder="Nombre del invitado..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-up-gold-500 focus:border-transparent"
                           oninput="filterData()">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por asistencia:</label>
                    <select id="filter-attendance" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-up-gold-500 focus:border-transparent" onchange="filterData()">
                        <option value="">Todos</option>
                        <option value="true">Solo confirmados</option>
                        <option value="false">Solo no asisten</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Ordenar por:</label>
                    <select id="sort-by" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-up-gold-500 focus:border-transparent" onchange="filterData()">
                        <option value="name">Nombre</option>
                        <option value="timestamp">Fecha de confirmaci√≥n</option>
                        <option value="guests">N√∫mero de acompa√±antes</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Lista de Asistentes -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="px-6 py-4 bg-up-gold-50 border-b border-up-gold-200">
                <h3 class="text-lg font-semibold text-up-gold-800">Lista de Asistentes</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Folio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">WhatsApp</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asistencia</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acompa√±antes</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Confirmaci√≥n</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="attendees-table" class="bg-white divide-y divide-gray-200">
                        <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>
            
            <div id="no-data" class="hidden p-8 text-center text-gray-500">
                <div class="text-6xl mb-4">üìù</div>
                <p class="text-lg">No hay confirmaciones registradas a√∫n.</p>
            </div>
        </div>
    </main>
    
    <!-- Footer con branding IUX -->
    <footer class="bg-gray-50 border-t border-gray-200 py-2">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <p class="text-xs text-gray-500">
                Sistema de invitaciones desarrollado por 
                <a href="https://iux.com.mx" target="_blank" rel="noopener" class="text-blue-600 hover:text-blue-800 font-medium">
                    IUX - Software Jur√≠dico
                </a>
            </p>
        </div>
    </footer>

    <script>
        // Variables globales
        let allConfirmations = [];
        let filteredConfirmations = [];
        let adminToken = localStorage.getItem('admin_access_token') || '';

        // Cargar datos al iniciar la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            loadConfirmations();
        });

        // Funci√≥n para cargar confirmaciones desde el backend
        async function loadConfirmations(forceTokenPrompt = false) {
            if (forceTokenPrompt) {
                const promptValue = prompt('Ingresa el token de administrador:') || '';
                adminToken = promptValue.trim();
                if (adminToken) {
                    localStorage.setItem('admin_access_token', adminToken);
                } else {
                    localStorage.removeItem('admin_access_token');
                }
            }

            const headers = {};
            if (adminToken) {
                headers['X-Admin-Token'] = adminToken;
            }

            try {
                const response = await fetch('/api/confirmations', { headers });

                if (response.status === 401 && !forceTokenPrompt) {
                    return loadConfirmations(true);
                }

                if (response.ok) {
                    allConfirmations = await response.json();
                    filteredConfirmations = [...allConfirmations];
                    updateStatistics();
                    displayConfirmations();
                } else {
                    if (response.status === 401) {
                        localStorage.removeItem('admin_access_token');
                        adminToken = '';
                        alert('Token de administrador inv√°lido. Intenta de nuevo.');
                    }
                    console.error('Error al cargar confirmaciones:', response.statusText);
                    showNoData();
                }
            } catch (error) {
                console.error('Error de conexi√≥n:', error);
                showNoData();
            }
        }

        // Funci√≥n para actualizar estad√≠sticas
        function updateStatistics() {
            const confirmed = allConfirmations.filter(c => c.will_attend === true);
            const declined = allConfirmations.filter(c => c.will_attend === false);
            const totalPeople = allConfirmations.reduce((sum, c) => sum + (c.will_attend ? 1 + c.guests : 0), 0);

            document.getElementById('confirmed-count').textContent = confirmed.length;
            document.getElementById('declined-count').textContent = declined.length;
            document.getElementById('total-people').textContent = totalPeople;
            document.getElementById('total-registrations').textContent = allConfirmations.length;
        }

        // Funci√≥n para mostrar confirmaciones en la tabla
        function displayConfirmations() {
            const tbody = document.getElementById('attendees-table');
            const noDataDiv = document.getElementById('no-data');

            if (filteredConfirmations.length === 0) {
                tbody.innerHTML = '';
                noDataDiv.classList.remove('hidden');
                return;
            }

            noDataDiv.classList.add('hidden');
            
            tbody.innerHTML = filteredConfirmations.map(confirmation => {
                const date = new Date(confirmation.timestamp).toLocaleString('es-ES');
                const attendanceStatus = confirmation.will_attend ? 
                    '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">‚úÖ S√ç ASISTE</span>' :
                    '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">‚ùå NO ASISTE</span>';
                
                return `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${confirmation.folio}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${confirmation.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${confirmation.phone}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${attendanceStatus}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${confirmation.guests}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${date}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            <button onclick="confirmDelete('${confirmation.folio}', '${confirmation.name}')" 
                                    class="text-red-600 hover:text-red-900 font-medium">
                                üóëÔ∏è Eliminar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Funci√≥n para filtrar datos
        function filterData() {
            const searchName = document.getElementById('search-name').value.toLowerCase();
            const filterAttendance = document.getElementById('filter-attendance').value;
            const sortBy = document.getElementById('sort-by').value;

            // Filtrar
            filteredConfirmations = allConfirmations.filter(confirmation => {
                const matchesName = confirmation.name.toLowerCase().includes(searchName);
                const matchesAttendance = filterAttendance === '' || 
                    confirmation.will_attend.toString() === filterAttendance;
                
                return matchesName && matchesAttendance;
            });

            // Ordenar
            filteredConfirmations.sort((a, b) => {
                switch (sortBy) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'timestamp':
                        return new Date(b.timestamp) - new Date(a.timestamp);
                    case 'guests':
                        return b.guests - a.guests;
                    default:
                        return 0;
                }
            });

            displayConfirmations();
        }

        // Funci√≥n para mostrar mensaje cuando no hay datos
        function showNoData() {
            document.getElementById('attendees-table').innerHTML = '';
            document.getElementById('no-data').classList.remove('hidden');
        }

        // Funci√≥n para actualizar datos
        function refreshData() {
            loadConfirmations();
        }

        // Funci√≥n para exportar a CSV
        function exportToCSV() {
            if (allConfirmations.length === 0) {
                alert('No hay datos para exportar');
                return;
            }

            const csvHeaders = ['Folio', 'Nombre', 'WhatsApp', 'Asiste', 'Acompa√±antes', 'Fecha Confirmaci√≥n'];
            const csvData = allConfirmations.map(confirmation => [
                confirmation.folio,
                confirmation.name,
                confirmation.phone,
                confirmation.will_attend ? 'S√ç' : 'NO',
                confirmation.guests,
                new Date(confirmation.timestamp).toLocaleString('es-ES')
            ]);

            const csvContent = [
                csvHeaders.join(','),
                ...csvData.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `asistentes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Funci√≥n para confirmar eliminaci√≥n de un registro
        async function confirmDelete(folio, name) {
            const confirmed = confirm(`¬øEst√°s seguro de eliminar la confirmaci√≥n de "${name}" (Folio: ${folio})?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmed) return;
            
            try {
                const response = await fetch(`/api/confirmations/${folio}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${result.message}`);
                    // Recargar datos
                    await loadConfirmations();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error al eliminar confirmaci√≥n:', error);
                alert('‚ùå Error al eliminar la confirmaci√≥n. Por favor intenta de nuevo.');
            }
        }

        // Funci√≥n para confirmar eliminaci√≥n de todos los registros
        async function confirmDeleteAll() {
            if (allConfirmations.length === 0) {
                alert('No hay registros para eliminar');
                return;
            }
            
            const confirmed = confirm(`‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\n¬øEst√°s ABSOLUTAMENTE SEGURO de eliminar TODAS las ${allConfirmations.length} confirmaciones?\n\nEsta acci√≥n es IRREVERSIBLE y eliminar√° todos los datos permanentemente.\n\nEscribe "ELIMINAR TODO" en el siguiente cuadro para confirmar.`);
            
            if (!confirmed) return;
            
            const verification = prompt('Para confirmar, escribe "ELIMINAR TODO" (sin comillas):');
            
            if (verification !== 'ELIMINAR TODO') {
                alert('‚ùå Cancelado. El texto no coincide.');
                return;
            }
            
            try {
                const response = await fetch('/api/confirmations', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`‚úÖ ${result.message}\nRegistros eliminados: ${result.deleted_count}`);
                    // Recargar datos
                    await loadConfirmations();
                } else {
                    const error = await response.json();
                    alert(`‚ùå Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error al eliminar todas las confirmaciones:', error);
                alert('‚ùå Error al eliminar las confirmaciones. Por favor intenta de nuevo.');
            }
        }
    </script>
</body>
</html>
